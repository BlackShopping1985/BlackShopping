<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>后台-新增商品</title>
</head>
<body>
  <h2>新增商品（纯前端版）</h2>
  <form id="form">
    名称：<input name="name" required><br>
    图片（多图）：<input type="file" name="pics" multiple accept="image/*" required><br>
    <button type="submit">提交</button>
  </form>
  <pre id="log"></pre>

  <script>

    
  /* 1. 把图片转 Base64（GitHub 静态页无法上传服务器，先转内联） */
  async function toBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
    });
  }

  /* 2. 提交：读 data.json → 加新项 → 推回仓库 */
  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    const item = {
      pics: await Promise.all([...f.pics.files].map(toBase64)),
      name: f.name.value 
      
    };

    const token = prompt('GitHub Personal Access Token:'); // 简单做法，生产环境用加密存储
    if(!token){ alert('需要 Token'); return; }

    console.log(token)

    const owner = 'BlackShopping1985';
    const repo  = 'BlackShopping';
    const path  = 'web/data.json';

    /* 2-1 获取当前文件 SHA */
    const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
      headers:{Authorization:token}
    }).then(r=>r.json());

    /* 2-2 把新商品合并进去 */
    const list = refRes.content ? JSON.parse(atob(refRes.content)) : [];
    list.push(item);

    // 这是一个辅助函数，用于正确处理包含非 ASCII 字符（如中文）的 Base64 编码
    // 这是一个辅助函数，用于正确处理包含非 ASCII 字符（如中文）的 Base64 编码
    function base64EncodeUnicode(str) {
        // 将字符串编码为 UTF-8 字节数组
        const utf8Bytes = new TextEncoder().encode(str);
        // 使用 String.fromCharCode 将字节数组转换为二进制字符串
        const binaryString = String.fromCharCode(...utf8Bytes);
        // 使用 btoa 进行 Base64 编码
        return btoa(binaryString);
    }
    
    /* 2-3 推送回仓库 */
    const body = {
        message:'chore: add product from admin',
        // 使用新的函数来替代 btoa()
        content: base64EncodeUnicode(JSON.stringify(list, null, 2)), 
        sha: refRes.sha
    };
    const pushRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
      method:'PUT',
      body: JSON.stringify(body),
      headers:{Authorization:`token ${token}`, 'Content-Type':'application/json'}
    }).then(r=>r.json());

    document.getElementById('log').textContent = pushRes.content ? '✅ 已提交，大概 30 秒后生效' : JSON.stringify(pushRes, null, 2);
  });
  </script>
</body>
</html>














