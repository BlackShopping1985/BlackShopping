<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>后台-新增商品</title>
</head>
<body>
  <h2>新增商品（纯前端版）</h2>
  <form id="form">
    名称：<input name="name" required><br>
    价格：<input type="number" name="price" required><br>
    库存：<input type="number" name="stock" required><br>
    图片（多图）：<input type="file" name="pics" multiple accept="image/*" required><br>
    <button type="submit">提交</button>
  </form>
  <pre id="log"></pre>

  <script>

    
  /* 1. 把图片转 Base64（GitHub 静态页无法上传服务器，先转内联） */
  async function toBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
    });
  }

  /* 2. 提交：读 data.json → 加新项 → 推回仓库 */
  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    const item = {
      name: f.name.value,
      price: Number(f.price.value),
      stock: Number(f.stock.value),
      pics: await Promise.all([...f.pics.files].map(toBase64))
    };

    const token = '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'; // 简单做法，生产环境用加密存储
    if(!token){ alert('需要 Token'); return; }

    console.log(token)

    const owner = 'BlackShopping1985';
    const repo  = 'BlackShopping';
    const path  = 'web/data.json';

    /* 2-1 获取当前文件 SHA */
    const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
      headers:{Authorization:`token ${token}`}
    }).then(r=>r.json());

    /* 2-2 把新商品合并进去 */
    const list = refRes.content ? JSON.parse(atob(refRes.content)) : [];
    list.push(item);

    /* 2-3 推送回仓库 */
    const body = {
      message:'chore: add product from admin',
      content: btoa(JSON.stringify(list, null, 2)),
      sha: refRes.sha
    };
    const pushRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${
      method:'PUT',
      body: JSON.stringify(body),
      headers:{Authorization:`token ${token}`, 'Content-Type':'application/json'}
    }).then(r=>r.json());

    document.getElementById('log').textContent = pushRes.content ? '✅ 已提交，大概 30 秒后生效' : JSON.stringify(pushRes, null, 2);
  });
  </script>
</body>
</html>






