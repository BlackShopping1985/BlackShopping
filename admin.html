<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>后台-新增商品</title>
</head>
<body>
  <h2>新增商品（纯前端版）</h2>
  <form id="form">
    
    名称：<input name="name" required><br> 
    图片（多图）：<input type="file" name="pics" multiple accept="image/*" required><br>
    <button type="submit">提交</button>
  </form>
  <pre id="log"></pre>

<script>

/* ==========  工具：UTF-8 → Base64 ========== */
function utoa(str) {
  return btoa(
    new TextEncoder().encode(str).reduce((a, b) => a + String.fromCharCode(b), '')
  );
}

/* ==========  工具：一次性“读-改-推” ========== */
async function pushToGitHub(owner, repo, path, token, newContent, message) {
  // ① 拿最新 SHA
  const refRes = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    { headers: { Authorization: `token ${token}` } }
  ).then(r => r.json());

  if (refRes.message) throw new Error(refRes.message);   // 404/403 等

  // ② 推送
  const body = {
    message,
    content: utoa(newContent),
    sha: refRes.sha
  };

  return fetch(
    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    {
      method: 'PUT',
      body: JSON.stringify(body),
      headers: {
        Authorization: `token ${token}`,
        'Content-Type': 'application/json'
      }
    }
  ).then(r => r.json());
}

/* ==========  提交事件 ========== */
document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const f = e.target;

  /* 1. 构造新商品 */
  const item = {
    name: f.name.value,
    pics: await Promise.all([...f.pics.files].map(file => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
      });
    }))
  };

  /* 2. 输入 Token */
  const token = prompt('GitHub Personal Access Token：');
  if (!token) { alert('需要 Token'); return; }

  /* 3. 仓库信息 */
  const owner = 'BlackShopping1985';
  const repo  = 'BlackShopping';
  const path  = 'web/data.json';

  try {
    /* 4. 先读最新数据 */
    const refRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
      { headers: { Authorization: `token ${token}` } }
    ).then(r => r.json());

    if (refRes.message) throw new Error(refRes.message);

    const list = refRes.content ? JSON.parse(atou(refRes.content)) : [];
    list.push(item);

    /* 5. 一次性推送 */
    const pushRes = await pushToGitHub(
      owner,
      repo,
      path,
      token,
      JSON.stringify(list, null, 2),
      'chore: add product from admin'
    );

    document.getElementById('log').textContent = pushRes.content
      ? '✅ 已提交，大概 30 秒后生效'
      : JSON.stringify(pushRes, null, 2);
  } catch (err) {
    alert('提交失败：' + err.message);
    console.error(err);
  }
});

/* ==========  工具：Base64 → UTF-8（读仓库时用） ========== */
function atou(base64) {
  return new TextDecoder().decode(
    Uint8Array.from(atob(base64), c => c.charCodeAt(0))
  );
}
</script>

</body>
</html>














