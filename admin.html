<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>后台-管理商品</title>
  <link rel="stylesheet" type="text/css" href="style_20251028.css">  
</head>
<body class="adminPage">

<h2>商品管理</h2>
<button id="addBtn" class="add-product-btn">+ 新增商品</button>

<!-- ===== 弹窗（新增） ===== -->
<div id="addModal" class="modal-mask">
  <div class="modal-box">
    <h3>新增商品</h3>
    <form id="modalForm">
      <p>名称：<input name="name" required></p><br>
      <p>图片（多图）：<input type="file" name="pics" multiple accept="image/*" required></p><br>
      <div style="width: 365px;height: 200px;display: flex;" class="desc">描述：<textarea name="desc" rows="3" ></textarea></div><br>
      <div class="modal-footer">
        <button type="submit">保存</button>
        <button type="button" id="cancelBtn">取消</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== 现有商品 ===== -->
<div class="admin-section">
  <h3>现有商品</h3>
  <div id="productList">加载中…</div>
</div>

<pre id="log"></pre>

<script>
/* ==========  工具：UTF-8 ↔ Base64  ========== */
function utoa(str) {
  return btoa(new TextEncoder().encode(str).reduce((a,b)=>a+String.fromCharCode(b),''));
}
function atou(base64) {
  return new TextDecoder().decode(Uint8Array.from(atob(base64),c=>c.charCodeAt(0)));
}

/* ==========  配置  ========== */
const owner = 'BlackShopping1985';
const repo  = 'BlackShopping';
const path  = 'web/data.json';
let token   = '';
let list    = [];

/* ==========  一次性“读-改-推”  ========== */
async function pushToGitHub(content, msg){
  const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    {headers:{Authorization:`token ${token}`}}).then(r=>r.json());
  if(refRes.message) throw new Error(refRes.message);
  return fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
    method:'PUT',
    body:JSON.stringify({message:msg, content:utoa(content), sha:refRes.sha}),
    headers:{Authorization:`token ${token}`,'Content-Type':'application/json'}
  }).then(r=>r.json());
}

/* ==========  初始加载  ========== */
function getToken() {
  const urlParams = new URLSearchParams(location.search);
  return urlParams.get('Token') ||            // ① 优先 URL
         localStorage.getItem('gh_token') ||  // ② 其次缓存
         '';                                  // ③ 没有就空
}

async function loadProducts(){
  token = getToken();
  if (!token) {                                      // 依然没有才弹
    token = prompt('GitHub Personal Access Token（将保存到 localStorage）');
    if (!token) { alert('需要 Token'); return; }
  }
  // 无论哪来的都存一份，下次同域免输入
  localStorage.setItem('gh_token', token);

  /* 以下照旧 … */
  try {
    const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
      {headers:{Authorization:`token ${token}`}}).then(r=>r.json());
    list = refRes.content ? JSON.parse(atou(refRes.content)) : [];
    renderList();
  } catch (e) { log(e.message||'加载失败'); }
}

/* ==========  渲染列表  ========== */
/* ==========  渲染列表（已改造）  ========== */
/* ==========  渲染列表（已带「+ 新增图片」）  ========== */
function renderList() {
  const box = document.getElementById('productList');
  if (!list.length) { box.innerHTML = '<p>暂无商品</p>'; return; }

  box.innerHTML = list.map((it, idx) => `
    <div class="product-edit" data-idx="${idx}">
      <input type="text" class="edit-name" value="${it.name}">
      <textarea class="edit-desc" rows="2" >${it.desc||''}</textarea>
      <div class="pic-row">
        ${it.pics.map((src, pIdx) => `
          <div class="pic-item" data-pic-idx="${pIdx}">
            <img src="${src}" alt="">
            <div class="pic-hover">
              <button type="button" class="replace-btn" title="替换"></button>
              <button type="button" class="del-pic-btn" title="删除"></button>
            </div>
          </div>
        `).join('')}
        <!--  ✅ + 新增图片  -->
        <div class="pic-item add-more-pic" data-idx="${idx}">
          <button type="button" class="add-pic-btn">+</button>
        </div>
      </div>
      <button class="save-btn">保存</button>
      <button class="del-btn">删除</button>
    </div>`).join('');

  // 悬停显按钮
  document.querySelectorAll('.pic-item').forEach(item => {
    item.addEventListener('mouseenter', () => item.classList.add('hover'));
    item.addEventListener('mouseleave', () => item.classList.remove('hover'));
  });
}
/* ==========  新增弹窗  ========== */
const addBtn = document.getElementById('addBtn');
const modal= document.getElementById('addModal');
const modalForm = document.getElementById('modalForm');
const cancelBtn = document.getElementById('cancelBtn');

addBtn.addEventListener('click',()=>modal.style.display='flex');
cancelBtn.addEventListener('click',()=>{modal.style.display='none';modalForm.reset();});

modalForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const f = e.target;
  const pics = await Promise.all([...f.pics.files].map(file=>{
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=reject;
    });
  }));  
  list.unshift({
    name : f.name.value,
    desc : f.desc.value,
    pics : pics   // 文件 Base64 数组
  });
  await save('chore: add product');
  modal.style.display='none'; modalForm.reset();
});

/* ==========  编辑 / 删除  ========== */
document.getElementById('productList').addEventListener('click',async(e)=>{
  const row = e.target.closest('.product-edit');
  if(!row)return;
  const idx = +row.dataset.idx;
  if(e.target.classList.contains('del-btn')){
    if(!confirm('确定删除？'))return;
    list.splice(idx,1); await save('chore: delete product'); return;
  }
  if(e.target.classList.contains('save-btn')){
    const nameInput = row.querySelector('.edit-name');
    const descInput = row.querySelector('.edit-desc');
    const fileInput = row.querySelector('.edit-pics');
    let pics = list[idx].pics;
    if(fileInput.files.length){
      pics = await Promise.all([...fileInput.files].map(file=>{
        return new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=reject;
        });
      }));
    }    
    list[idx] = {name:nameInput.value,desc :descInput.value}; await save('chore: update product info');
  }
});

/* ==========  统一保存  ========== */
async function save(msg){
  try{
    const res = await pushToGitHub(JSON.stringify(list,null,2),msg);
    log(res.content?'✅ 保存成功':'❌ 保存失败');
    renderList();
  }catch(e){ log(e.message||'保存失败'); }
}

function log(txt){
  document.getElementById('log').textContent = typeof txt==='string'?txt:JSON.stringify(txt,null,2);
}

/* ==========  入口  ========== */
loadProducts();



/* ==========  单张图替换 / 删除  ========== */
document.getElementById('productList').addEventListener('click', async (e) => {
  const picItem = e.target.closest('.pic-item');
  if (!picItem) return;
  const row   = picItem.closest('.product-edit');
  const idx   = +row.dataset.idx;
  const pIdx  = +picItem.dataset.picIdx;

  if (e.target.classList.contains('del-pic-btn')) {
    if (!confirm('删除这张图片？')) return;
    list[idx].pics.splice(pIdx, 1);          // 删掉这张
    if (!list[idx].pics.length) list[idx].pics = ['img/placeholder.jpg']; // 保底
    await save('chore: delete single pic');
    return;
  }

  if (e.target.classList.contains('replace-btn')) {
    // 生成隐藏 file input 并点击
    let fileInp = picItem.querySelector('input[type=file]');
    if (!fileInp) {
      fileInp = document.createElement('input');
      fileInp.type = 'file';
      fileInp.accept = 'image/*';
      fileInp.style.display = 'none';
      picItem.appendChild(fileInp);
    }
    fileInp.onchange = async () => {
      if (!fileInp.files[0]) return;
      const newBase64 = await new Promise(r => {
        const reader = new FileReader();
        reader.readAsDataURL(fileInp.files[0]);
        reader.onload = () => r(reader.result);
      });
      list[idx].pics[pIdx] = newBase64;   // 原地替换
      await save('chore: replace single pic');
    };
    fileInp.click();
  }
});  

/* ==========  追加新图片（放在最后）  ========== */
document.getElementById('productList').addEventListener('click', async (e) => {
  const addBtn = e.target.closest('.add-pic-btn');
  if (!addBtn) return;
  const row  = addBtn.closest('.product-edit');
  const idx  = +row.dataset.idx;

  // 创建隐藏 input 并点击
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'image/*';
  inp.style.display = 'none';
  inp.onchange = async () => {
    if (!inp.files[0]) return;
    const base64 = await new Promise(r => {
      const reader = new FileReader();
      reader.readAsDataURL(inp.files[0]);
      reader.onload = () => r(reader.result);
    });
    list[idx].pics.push(base64);   // 追加到尾部
    await save('chore: append pic');
  };
  document.body.appendChild(inp);
  inp.click();
  inp.remove();
});  
  
</script>
</body>
</html>










