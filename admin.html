<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>后台-管理商品</title>
  <link rel="stylesheet" type="text/css" href="style_20251028.css">  
</head>
<body class="adminPage">

<h2>商品管理</h2>
<button id="addBtn" class="add-product-btn">+ 新增商品</button>

<!-- ===== 弹窗（新增） ===== -->
<div id="addModal" class="modal-mask">
  <div class="modal-box">
    <h3>新增商品</h3>
    <form id="modalForm">
      名称：<input name="name" required><br>
      图片（多图）：<input type="file" name="pics" multiple accept="image/*" required><br>
      <div class="modal-footer">
        <button type="submit">保存</button>
        <button type="button" id="cancelBtn">取消</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== 现有商品 ===== -->
<div class="admin-section">
  <h3>现有商品</h3>
  <div id="productList">加载中…</div>
</div>

<pre id="log"></pre>

<script>
/* ==========  工具：UTF-8 ↔ Base64  ========== */
function utoa(str) {
  return btoa(new TextEncoder().encode(str).reduce((a,b)=>a+String.fromCharCode(b),''));
}
function atou(base64) {
  return new TextDecoder().decode(Uint8Array.from(atob(base64),c=>c.charCodeAt(0)));
}

/* ==========  配置  ========== */
const owner = 'BlackShopping1985';
const repo  = 'BlackShopping';
const path  = 'web/data.json';
let token   = '';
let list    = [];

/* ==========  一次性“读-改-推”  ========== */
async function pushToGitHub(content, msg){
  const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
    {headers:{Authorization:`token ${token}`}}).then(r=>r.json());
  if(refRes.message) throw new Error(refRes.message);
  return fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
    method:'PUT',
    body:JSON.stringify({message:msg, content:utoa(content), sha:refRes.sha}),
    headers:{Authorization:`token ${token}`,'Content-Type':'application/json'}
  }).then(r=>r.json());
}

/* ==========  初始加载  ========== */
async function loadProducts(){
  token = localStorage.getItem('gh_token') || '';
  if(!token){
    token = prompt('GitHub Personal Access Token（将保存到 localStorage）');
    if(!token){ alert('需要 Token'); return; }
    localStorage.setItem('gh_token',token);
  }
  try{
    const refRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
      {headers:{Authorization:`token ${token}`}}).then(r=>r.json());
    list = refRes.content ? JSON.parse(atou(refRes.content)) : [];
    renderList();
  }catch(e){ log(e.message||'加载失败'); }
}

/* ==========  渲染列表  ========== */
function renderList(){
  const box = document.getElementById('productList');
  if(!list.length){ box.innerHTML='<p>暂无商品</p>'; return; }
  box.innerHTML = list.map((it,idx)=>`
    <div class="product-edit" data-idx="${idx}">
      <img src="${it.pics?.[0]||'img/placeholder.jpg'}" alt="">
      <input type="text" class="edit-name" value="${it.name}">
      <input type="file" class="edit-pics" multiple accept="image/*">
      <button class="save-btn">保存</button>
      <button class="del-btn">删除</button>
    </div>`).join('');
}

/* ==========  新增弹窗  ========== */
const addBtn = document.getElementById('addBtn');
const modal= document.getElementById('addModal');
const modalForm = document.getElementById('modalForm');
const cancelBtn = document.getElementById('cancelBtn');

addBtn.addEventListener('click',()=>modal.style.display='flex');
cancelBtn.addEventListener('click',()=>{modal.style.display='none';modalForm.reset();});

modalForm.addEventListener('submit',async(e)=>{
  e.preventDefault();
  const f = e.target;
  const pics = await Promise.all([...f.pics.files].map(file=>{
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=reject;
    });
  }));
  list.push({name:f.name.value,pics});
  await save('chore: add product');
  modal.style.display='none'; modalForm.reset();
});

/* ==========  编辑 / 删除  ========== */
document.getElementById('productList').addEventListener('click',async(e)=>{
  const row = e.target.closest('.product-edit');
  if(!row)return;
  const idx = +row.dataset.idx;
  if(e.target.classList.contains('del-btn')){
    if(!confirm('确定删除？'))return;
    list.splice(idx,1); await save('chore: delete product'); return;
  }
  if(e.target.classList.contains('save-btn')){
    const nameInput = row.querySelector('.edit-name');
    const fileInput = row.querySelector('.edit-pics');
    let pics = list[idx].pics;
    if(fileInput.files.length){
      pics = await Promise.all([...fileInput.files].map(file=>{
        return new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=reject;
        });
      }));
    }
    list[idx]={name:nameInput.value,pics}; await save('chore: update product');
  }
});

/* ==========  统一保存  ========== */
async function save(msg){
  try{
    const res = await pushToGitHub(JSON.stringify(list,null,2),msg);
    log(res.content?'✅ 保存成功':'❌ 保存失败');
    renderList();
  }catch(e){ log(e.message||'保存失败'); }
}

function log(txt){
  document.getElementById('log').textContent = typeof txt==='string'?txt:JSON.stringify(txt,null,2);
}

/* ==========  入口  ========== */
loadProducts();
</script>
</body>
</html>
